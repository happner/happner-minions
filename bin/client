#!/usr/bin/env node

var opts = JSON.parse(process.argv[2]);

console.log('OPTS:', opts);

var name = opts.config.name;
var marshal = opts.marshal;
var clientConfig = opts.config.clientConfig;
var script = opts.config.script;
var errorize = require('errorize');

var Script = require((opts.config.home || '..') + '/scripts/mesh_' + script);

var Happner = require('happner');

var error = function(e) {
  e = errorize(e);
  if (report && report.exchange) {
    return report.exchange['happner-minions'].minionError(name, errorize.encode(e, 3))
    .then(function() {
      process.exit(1);
    })
    .catch(function() {
      console.error(e);
      process.exit(1);
    });
  }
  process.exit(1);
}

// Reports back to marshal.
var report = new Happner.MeshClient({
  host: marshal.datalayer.address.address,
  port: marshal.datalayer.address.port,
});

console.log(clientConfig);

var client = new Happner.MeshClient(clientConfig);

report.login()
.then(function() {
  return client.login();
})
.then(function() {

  return report.exchange['happner-minions'].minionReady({
    name: name,
    timestamp: Date.now(),
    task: {
      title: Script.title,
      stepsRemaining: Script.steps,
      stepsDone: {}
    }
  })
  .then(function() {

    // return Script.run(opts.config, report, mesh);

  });

})

.catch(error);
