#!/usr/bin/env node

var opts = JSON.parse(process.argv[2]);

var marshal = opts.marshal;
var config = opts.config.config;
var script = opts.config.script;
var name = opts.config.name;
var user = opts.config.user || {};
var externalInterfaces = require('../lib//util').externalInterfaces;
var errorize = require('errorize');

var Config = require((opts.config.home || '..') + '/configs/mesh_' + config);
var Script = require((opts.config.home || '..') + '/scripts/mesh_' + script);

Config.name = name;

var Happner = require('happner');

var error = function(e) {

  if (report && report.exchange) {
    var ee = errorize(e); // grrrr  !!!!!!BAN ON THROWING STRINGS!!!!!!
    return report.exchange['happner-minions'].minionError(name, ee)
    .then(function() {
      process.exit(1);
    })
    .catch(function() {
      console.error(e);
      process.exit(1);
    })

  }
  process.exit(1);
}

// Reports back to marshal.
var report = new Happner.MeshClient({
  host: marshal.datalayer.address.address,
  port: marshal.datalayer.address.port,
});

report.login()
.then(function() {
  return Happner.create(Config)
})
.then(function(mesh) {
  var name = mesh._mesh.config.name;

  var address = mesh._mesh.datalayer.server.server.address();
  if (address.address == '0.0.0.0') {
    // assume first iface
    var ifaces = externalInterfaces();
    address.address = ifaces[0];
  }

  return report.exchange['happner-minions'].minionReady({
    name: name,
    address: address,
    timestamp: Date.now(),
    task: {
      title: Script.title,
      stepsRemaining: Script.steps,
      stepsDone: {}
    }
  })
  .then(function() {

    
    // return Script.run(name, report, mesh);

  })
})
.catch(error);
