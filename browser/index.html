<html>
    <head>
        <script src=/api/client></script>
    </head>
    <body>
        <script>

            // window.LOG_LEVEL = 'debug';

            document.body.innerHTML = '<h4>connecting...</h4>';

            var credentials = {
                username: localStorage.username,
                password: localStorage.password,
            };

            var client = window.client = new MeshClient();

            var start = function() {
                document.body.innerHTML = '';

                client.event['happner-minions'].on('notify', function(info) {
                    console.log('NOTIFY:', info.message, info.info);
                });

                client.event['happner-minions'].on('error', function(info) {
                    console.error(info.type, info.error, info.object);
                });

                window.listMarshals = function() {
                    client.exchange['happner-minions'].listMarshals()
                    .then(function(result) {
                        // console.log('RESULT\n', JSON.stringify(result, null, 2))
                        console.log('listMarshals result:', result);
                    })
                    .catch(function(e) {
                        console.error(e);
                    });
                }

                window.listMinions = function(opts) {
                    client.exchange['happner-minions'].listMinions(opts)
                    .then(function(result) {
                        // console.log('RESULT\n', JSON.stringify(result, null, 2))
                        console.log('listMinions result:', result);
                    })
                    .catch(function(e) {
                        console.error(e);
                    });
                }

                window.killMinions = function(opts) {
                    client.exchange['happner-minions'].killMinions(opts)
                    .then(function(result) {
                        // console.log('RESULT\n', JSON.stringify(result, null, 2))
                        console.log('killMinions result:', result);
                    })
                    .catch(function(e) {
                        console.error(e);
                    }); 
                }

                window.killMinion = function(name) {
                    client.exchange['happner-minions'].killMinion(name)
                    .then(function(result) {
                        // console.log('RESULT\n', JSON.stringify(result, null, 2))
                        console.log('killMinion result:', result);
                    })
                    .catch(function(e) {
                        console.error(e);
                    }); 
                }

                window.runScript = function(scriptName, opts) {
                    client.exchange['happner-minions'].runScript(scriptName, opts)
                    .then(function(result) {
                        // console.log('RESULT\n', JSON.stringify(result, null, 2))
                        console.log('runScript result:', result);
                    })
                    .catch(function(e) {
                        console.error(e);
                    });
                }

                window.viewScript = function(scriptName, opts) {
                    client.exchange['happner-minions'].viewScript(name, opts)
                    .then(function(result) {
                        // console.log('RESULT\n', JSON.stringify(result, null, 2))
                        console.log('viewScript result:', result);
                    })
                    .catch(function(e) {
                        console.error(e);
                    });
                }

                // client.event.www.on('update', function(data) {
                //     document.body.innerHTML = 
                //         '<pre>' + 
                //         JSON.stringify(data, null, 2) +
                //         '</pre>';
                // });
            }

            var error = function(e) {
                document.body.innerHTML = 
                    '<h4>' + e.message + '</h4>' +
                    'In javascript console...' +
                    '<p style="font-family: courier; font-size: small">' +
                    'localStorage.username = \'yours\';<br/>' +
                    'localStorage.password = \'yours\';</p>' +
                    '...then refresh page.';   
            }

            client.login(credentials).then(start).catch(error);

        </script>
    </body>
</html>
